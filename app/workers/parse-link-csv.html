<!doctype html>
<html>
<head>
  <script>
  const electron = require('electron');
  const Baby = require('babyparse');
  const Lazy = require('lazy.js');

  var defaultNode = {
    id: '',
    index: -1,
    padding: 0,
    selected: false,
    seq: ''
  };

  var instructions = {
    supplement: '',
    identifierColumn: 'id',
    sequenceColumn: 'seq',
    align: true,
    sourceColumn: 'source',
    targetColumn: 'target'
  };

  var index = 0;

  electron.ipcRenderer.on('deliver-instructions', (sender, i) => {
    Object.assign(instructions, i);
    electron.ipcRenderer.send('message', 'Parsing Link CSV...');
    var parsed = Baby.parseFiles(instructions.file, {
      header: true,
      dynamicTyping: true,
      skipEmptyLines: true
    });
    var links = parsed.data;
    links.forEach(link => {
      link.index = index++;
      link.orig = true;
      link.source = link[instructions.sourceColumn];
      link.target = link[instructions.targetColumn];
    });
    electron.ipcRenderer.send('message', ' - Parsed ' + links.length + ' Links.');

    electron.ipcRenderer.send('message', 'Inferring Nodes...');
    var llinks = Lazy(links);
    var nodes  = Lazy(
          llinks.pluck('source').union(
          llinks.pluck('target'))
        ).map((e, i) => ({
          id: e,
          index: i,
          padding: 0,
          selected: false,
          seq: ''
        })).toArray();
    electron.ipcRenderer.send('message', ' - Inferred ' + nodes.length + ' distinct nodes.');

    if(instructions.supplement !== ''){
      electron.ipcRenderer.send('message', 'Parsing Node CSV...');
      var parsed = Baby.parseFiles(instructions.supplement, {
        header: true,
        dynamicTyping: true,
        skipEmptyLines: true
      });
      var csvNodes = parsed.data;
      electron.ipcRenderer.send('message', ' - Parsed ' + csvNodes.length + ' nodes from Supplement CSV.');

      var k = 0, l = 0;
      electron.ipcRenderer.send('message', 'Matching to Inferred nodes...');
      csvNodes.forEach(node => {
        var match = nodes.find(n => n.id == node[instructions.identifierColumn]);
        if(match){
          Object.assign(match, node);
          k++;
        } else {
          nodes.push(Object.assign({}, defaultNode, node, {index: index++}));
          l++;
        }
      });
      electron.ipcRenderer.send('message', ' - Matched ' + k + ' nodes.\n - Identified ' + l + ' singleton nodes.');
    }

    electron.ipcRenderer.send('update-data', {
      links: links,
      nodes: nodes
    });
    electron.remote.getCurrentWindow().close();
  });
  </script>
</head>
</html>
