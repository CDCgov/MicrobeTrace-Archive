<!doctype html>
<html>
<head>
  <script>
  const electron = require('electron');
  const jetpack = require('fs-jetpack');
  const Papa = require('papaparse');
  const Lazy = require('lazy.js');

  var data = {
    nodes: [],
    links: []
  };

  var defaultNode = {
    id: '',
    index: -1,
    padding: 0,
    selected: false,
    seq: ''
  };

  var instructions = {
    supplement: '',
    identifierColumn: 'id',
    sequenceColumn: 'seq',
    align: true,
    sourceColumn: 'source',
    targetColumn: 'target'
  };

  var index = 0;

  electron.ipcRenderer.on('deliver-instructions', (sender, i) => {
    Object.assign(instructions, i);
    electron.ipcRenderer.send('message', 'Parsing Link CSV...');
    var results = Papa.parse(jetpack.read(instructions.file), {
      header: true,
      dynamicTyping: true,
      skipEmptyLines: true
    });

    data.links = results.data.map(link => {
      link.index = index++;
      link.orig = true;
      link.source = link[instructions.sourceColumn];
      link.target = link[instructions.targetColumn];
      return link;
    });
    electron.ipcRenderer.send('message', ' - Parsed ' + data.links.length + ' Links.');

    electron.ipcRenderer.send('message', 'Inferring Nodes...');
    var llinks = Lazy(data.links);
    data.nodes = Lazy(
        llinks.pluck(instructions.sourceColumn).union(
        llinks.pluck(instructions.targetColumn))
      ).map((e, i) => ({
        id: e,
        index: i,
        padding: 0,
        selected: false,
        seq: ''
      })).toArray();
    electron.ipcRenderer.send('message', ' - Inferred ' + data.nodes.length + ' distinct nodes.');
    if(instructions.supplement){
      matchCSV();
    }
    electron.ipcRenderer.send('update-data', data);
    electron.remote.getCurrentWindow().close();
  });

  function matchCSV(){
    electron.ipcRenderer.send('message', 'Parsing Node CSV...');
    var k = 0, l = 0, output = [];

    var results = Papa.parse(jetpack.read(instructions.supplement), {
      header: true,
      dynamicTyping: true,
      skipEmptyLines: true
    });
    electron.ipcRenderer.send('message', ' - Parsed ' + results.data.length + ' nodes from Supplement CSV.');

    electron.ipcRenderer.send('message', 'Matching to Inferred nodes...');
    results.data.forEach(node => {
      var match = data.nodes.find(n => n.id == node[instructions.identifierColumn]);
      if(match){
        Object.assign(match, node);
        k++;
      } else {
        Object.assign({}, defaultNode, node, {index: index++});
        l++;
      }
    });
    electron.ipcRenderer.send('message', ' - Matched ' + k + ' nodes.')
    electron.ipcRenderer.send('message', ' - Identified ' + l + ' singleton nodes.');
  }

  </script>
</head>
</html>
